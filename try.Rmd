---
title: "COVID-19 around the world"
author:
 - name: "Annette Lien (s202633)"
 - name: "Carlota Carbajo Moral (s202424)"
 - name: "Mathias Fynbo Jensen (s192065)"
 - name: "Thomas Carvalho Andersen (s202755)"
date: "10/5/2021"
output: 
  ioslides_presentation:
    logo: presentation-figure/dtu-logo-png-transparent.png
    widescreen: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Index

- Data description
- Data loading
- Data cleaning
- Data augmentation
- Data analysis
- Conclusion

## Data description

For this project we merged data from two main sources: John Hopkins and Gapminder.

<div class="columns-2">
### John Hopkins data - [Repository Link](https://github.com/CSSEGISandData/COVID-19)

- Main datasets of the project
  - Time series of COVID-19 confirmed cases
  - Time series of COVID-19 deaths
  - Population count (IUD)
  


### Gapminder data - [Website Link](https://www.gapminder.org/data/)

- 18 datasets of varying relevance including:  
  - Life expectancy
  - Smoking and Alcohol Consumption
  - Body Mass Index and Basic Sanitation

</div>

## Data loading

```{r, message = FALSE, results='hide'}
library("tidyverse")

```


```{r, echo = TRUE, message = FALSE, results = 'hide'}
data01_raw <- read_csv(file = "data/_raw/01_time_series_covid19_confirmed_global.csv")

```
```{r, echo = TRUE}
data01_raw
```

## Data loading
Similar procedure for datasets 01 to 03.
```{r , echo = TRUE}
data01_raw <- data01_raw %>%
  select('Country/Region', '4/29/21') %>% 
  rename('Cases' = '4/29/21') %>% 
  rename('Country' = 'Country/Region')
data01_raw

```

## Data loading
```{r, echo = FALSE}
data04_raw <- read.csv(file = "data/_raw/04_urban_population_percent_of_total.csv")
data05_raw <- read.csv(file = "data/_raw/05_life_expectancy_years.csv")
data06_raw <- read.csv(file = "data/_raw/06_smoking_adults_percent_of_population_over_age_15.csv")

```

Similar procedure for datasets 04 to 24.
```{r, echo = TRUE}
data04_raw <- data04_raw  %>% 
  select(country, X2019) %>% 
  rename(UrbanPop = X2019)
data05_raw <- data05_raw  %>% 
  select(country, X2017) %>% 
  rename(LifeExp = X2017)
data06_raw <- data06_raw  %>% 
  select(country, X2005) %>% 
  rename(Smoking = X2005)
data04_raw
```

## Data cleaning
```{r, echo=FALSE, message=FALSE}
#Make list of input files
my_files = list.files(path = "/cloud/project/data",
                      pattern = "^01_.+\\.tsv$")

#The working directory is changed to retrieve the data
setwd("/cloud/project/data")

#Read in data as tsv
my_data = map(my_files, read_tsv)

setwd("/cloud/project")
```

Similar procedure for datasets 01 to 03.
```{r, echo=TRUE}
data01 <- my_data %>%
  pluck(1) %>% 
  group_by(Country) %>% 
  summarise_all(sum)
data01
```
```{r, echo = FALSE}
data02 <- my_data %>% 
  pluck(2) %>% 
  group_by(Country) %>% 
  summarise_all(sum)

data03 <- my_data %>% 
  pluck(3)
```

## Data cleaning
```{r, echo = TRUE, warning=FALSE}
data_covid <- data01 %>% 
  left_join(data02, by="Country") %>% 
  left_join(data03, by="Country")


data_gapminder <- my_data[4:21] %>% 
  reduce(full_join, 
         by="country")

data_gapminder <- data_gapminder %>% 
  mutate_if(is_numeric,
            function(x)
            {replace_na(x, 
                        mean(x,
                             na.rm=TRUE))
            })
```
```{r, echo = FALSE}
data_gapminder <- data_gapminder %>% 
  mutate(country = case_when(country == "Myanmar" ~ "Burma",
                             country == "Cape Verde" ~ "Cabo Verde",
                             country == "Congo, Rep." ~ "Congo (Brazzaville)",
                             country == "Congo, Dem. Rep." ~ "Congo (Kinshasa)",
                             country == "Czech Republic" ~ "Czechia",
                             country == "South Korea" ~ "Korea, South",
                             country == "" ~ "Kosovo",
                             country == "Kyrgyz Republic" ~ "Kyrgyzstan",
                             country == "Lao" ~ "Laos",
                             country == "Micronesia, Fed. Sts." ~ "Micronesia",
                             country == "St. Kitts and Nevis" ~ "Saint Kitts and Nevis",
                             country == "St. Lucia" ~ "Saint Lucia",
                             country == "St. Vincent and the Grenadines" ~ "Saint Vincent and the Grenadines",
                             country == "Slovak Republic" ~ "Slovakia",
                             country == "" ~ "Taiwan*",
                             country == "United States" ~ "US",
                             country == "Palestine" ~ "West Bank and Gaza",
                             TRUE ~ country)) %>% 
  rename('Country' = 'country')

data_continent <- my_data %>% 
  pluck(22) %>% 
  mutate(country = case_when(country == "Congo" ~ "Congo (Brazzaville)",
                             country == "CÃ´te D'Ivoire" ~ "Cote d'Ivoire",
                             country == "Democratic Republic of the Congo" ~ "Congo (Kinshasa)",
                             country == "Bolivia (Plurinational State of)" ~ "Bolivia",
                             country == "Venezuela, Bolivarian Republic of" ~ "Venezuela",
                             country == "Brunei Darussalam" ~ "Brunei",
                             country == "Myanmar" ~ "Burma",
                             country == "Swaziland" ~ "Eswatini",
                             country == "Czech Republic" ~ "Czechia",
                             country == "Gambia (Islamic Republic of the)" ~ "Gambia",
                             country == "Guinea Bissau" ~ "Guinea-Bissau",
                             country == "Holy See (Vatican City State)" ~ "Holy See",
                             country == "Iran (Islamic Republic of)" ~ "Iran",
                             country == "Republic of Korea" ~ "Korea, South",
                             country == "Lao People's Democratic Republic" ~ "Laos",
                             country == "Micronesia (Federated States of)" ~ "Micronesia",
                             country == "Republic of Moldova" ~ "Moldova",
                             country == "The former Yugoslav Republic of Macedonia" ~ "North Macedonia",
                             country == "Russian Federation" ~ "Russia",
                             country == "Syrian Arab Republic" ~ "Syria",
                             country == "Taiwan, Province of China" ~ "Taiwan*",
                             country == "United Republic of Tanzania" ~ "Tanzania",
                             country == "United Kingdom of Great Britain and Northern Ireland" ~ "United Kingdom",
                             country == "United States of America" ~ "US",
                             country == "Viet Nam" ~ "Vietnam",
                             country == "Palestine, State of" ~ "West Bank and Gaza",
                             country == "Democratic People's Republic of Korea" ~ "North Korea",
                             TRUE ~ country)) %>% 
         rename(Country = country)



```

## Data cleaning
Before the final join some of the names had to be fixed so both data_covid and data_gapminder agreed in the country names.
```{r, echo=TRUE}
data_full <- data_covid %>% 
  full_join(data_continent, by="Country") %>% 
  full_join(data_gapminder, by="Country")
data_full
```

## Data augmentation
We added new attributes to the dataset
```{r, echo=FALSE, message = FALSE}
library("patchwork")
data_clean <- read_tsv(file = "data/02_data_clean.tsv")
```

```{r, echo=TRUE, message=FALSE}
data_clean_aug <- data_clean %>%
  mutate(Casesper100kpp = round((Cases / Population * 100000), digits = 2)) %>% 
  mutate(Deathsper100kpp = round((Deaths / Population * 100000), digits = 2)) %>%
  mutate(FatalityRate = round((Deaths / Cases * 100), digits = 2)) %>%
  mutate(PopDens = round(Population/LandSqkm,digits = 2)) %>%
  mutate(Fatality_class = case_when(FatalityRate < mean(FatalityRate) ~ "low fatality",
                                    FatalityRate > mean(FatalityRate) ~ "high fatality")) %>%
  mutate(BMI_m_class = case_when(BMI_m < 18.5 ~ "underweight",
                               18.5 <= BMI_m & BMI_m < 24.9 ~ "normal weight",
                               24.9 <= BMI_m & BMI_m < 29.9 ~ "overweight",
                               29.9 <= BMI_m & BMI_m < 35 ~ "obese",
                               35 <= BMI_m & BMI_m < 40 ~ "severe obesity",
                               40 <= BMI_m & BMI_m < 50 ~ "morbid obesity",
                               50 <= BMI_m ~ "super obese" )) %>%
  mutate(BMI_f_class = case_when(BMI_f < 18.5 ~ "underweight",
                               18.5 <= BMI_f & BMI_f < 24.9 ~ "normal weight",
                               24.9 <= BMI_f & BMI_f < 29.9 ~ "overweight",
                               29.9 <= BMI_f & BMI_f < 35 ~ "obese",
                               35 <= BMI_f & BMI_f < 40 ~ "severe obesity",
                               40 <= BMI_f & BMI_f < 50 ~ "morbid obesity",
                               50 <= BMI_f ~ "super obese" ))
```


## Data analysis
```{r, echo=FALSE, message=FALSE}
data_clean_aug <- read_tsv(file = "data/03_data_clean_aug.tsv")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
pl1 <- data_clean_aug %>% ggplot(mapping = aes(x = continent, y = Casesper100kpp, fill = continent)) +
  geom_boxplot(alpha = 0.5) +
  labs(x = "Continent",
       y = "Number of cases per 100k inhabitants",
       fill = "Continent") +
  theme_classic(base_size = 18,
                base_family = "Avenir") +
  theme(legend.position = "none",axis.title = element_text(size = 12),
        axis.text.x = element_text(size = 8),axis.text.y = element_text(size = 8))
pl2 <- data_clean_aug %>% ggplot(mapping = aes(x = continent, y = Deathsper100kpp, fill = continent)) +
  geom_boxplot(alpha = 0.5) +
  labs(x = "Continent",
       y = "Number of deaths per 100k inhabitants",
       fill = "Continent") +
  theme_classic(base_size = 18,
                base_family = "Avenir") +
  theme(legend.position = "none",axis.title = element_text(size = 12),
        axis.text.x = element_text(size = 8), axis.text.y = element_text(size = 8))
pl3 <- data_clean_aug %>% ggplot(mapping = aes(x = continent, y = FatalityRate, fill = continent)) +
  geom_boxplot(alpha = 0.5) +
  labs(x = "Continent",
       y = "Fatality rate",
       fill = "Continent") +
  theme_classic(base_size = 18,
                base_family = "Avenir") +
  theme(legend.position = "none",axis.title = element_text(size = 12),
        axis.text.x = element_text(size = 8), axis.text.y = element_text(size = 8))

pl1 + pl2 / pl3
```

## Data analysis
```{r, echo=FALSE, message=FALSE}
data_clean_aug %>% 
  ggplot(mapping = aes(x= Smoking, y = Deathsper100kpp, fill=continent)) + 
  #facet_wrap(~continent)+ # We can use this or not
  labs(x = "Smoking index",
       y = "Number of deaths per 100k inhabitants")+
  geom_smooth(method = lm) +
  geom_point()+
  theme(legend.position = "bottom")
```

## Data analysis
```{r}
data_clean_aug %>% 
  ggplot(mapping = aes(x = FatalityRate,
                     fill=continent)) +
  geom_density(alpha = 0.5)+
  labs(x = "Fatality rate",
       y = "Density")

```

## Data analysis
```{r}
data_clean_aug %>% filter(continent=='Europe') %>%
  ggplot(mapping = aes(x = Country, y = FatalityRate, color=Fatality_class)) + 
  geom_point() +
  coord_flip()+
  geom_hline(yintercept = 2.070798, linetype = "dashed")+
  theme(legend.position = "right",axis.text.y = element_text(size = 7))+
  labs(x = "Country",
       y = "Fatality rate")
```

